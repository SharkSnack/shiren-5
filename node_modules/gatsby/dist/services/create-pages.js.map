{"version":3,"sources":["../../src/services/create-pages.ts"],"names":["createPages","parentSpan","gatsbyNodeGraphQLFunction","store","deferNodeMutation","shouldRunCreatePagesStatefully","activity","reporter","activityTimer","start","timestamp","Date","now","currentPages","Map","getState","pages","graphql","traceId","waitForCascadingActions","span","end","info","nodes","size","nodesByType","get","process","env","gatsby_log_level","verbose","entries","map","type","join","deletedPages","length","tim","changedPages","dispatch","actions","apiFinished","apiName"],"mappings":"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","sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport { IDataLayerContext } from \"../state-machines/data-layer/types\"\nimport { assertStore } from \"../utils/assert-store\"\nimport { IGatsbyPage } from \"../redux/types\"\nimport { actions } from \"../redux/actions\"\nimport { deleteUntouchedPages, findChangedPages } from \"../utils/changed-pages\"\n\nexport async function createPages({\n  parentSpan,\n  gatsbyNodeGraphQLFunction,\n  store,\n  deferNodeMutation,\n  shouldRunCreatePagesStatefully,\n}: Partial<IDataLayerContext>): Promise<{\n  deletedPages: Array<string>\n  changedPages: Array<string>\n}> {\n  assertStore(store)\n  const activity = reporter.activityTimer(`createPages`, {\n    parentSpan,\n  })\n  activity.start()\n  const timestamp = Date.now()\n  const currentPages = new Map<string, IGatsbyPage>(store.getState().pages)\n  await apiRunnerNode(\n    `createPages`,\n    {\n      graphql: gatsbyNodeGraphQLFunction,\n      traceId: `initial-createPages`,\n      waitForCascadingActions: true,\n      parentSpan: activity.span,\n      deferNodeMutation,\n    },\n    { activity }\n  )\n  activity.end()\n\n  if (shouldRunCreatePagesStatefully) {\n    const activity = reporter.activityTimer(`createPagesStatefully`, {\n      parentSpan,\n    })\n    activity.start()\n    await apiRunnerNode(\n      `createPagesStatefully`,\n      {\n        graphql: gatsbyNodeGraphQLFunction,\n        traceId: `initial-createPagesStatefully`,\n        waitForCascadingActions: true,\n        parentSpan: activity.span,\n        deferNodeMutation,\n      },\n      {\n        activity,\n      }\n    )\n    activity.end()\n  }\n\n  reporter.info(\n    `Total nodes: ${store.getState().nodes.size}, SitePage nodes: ${\n      store.getState().nodesByType?.get(`SitePage`)?.size\n    } (use --verbose for breakdown)`\n  )\n\n  if (process.env.gatsby_log_level === `verbose`) {\n    reporter.verbose(\n      `Number of node types: ${\n        store.getState().nodesByType.size\n      }. Nodes per type: ${[...store.getState().nodesByType.entries()]\n        .map(([type, nodes]) => type + `: ` + nodes.size)\n        .join(`, `)}`\n    )\n  }\n\n  reporter.verbose(`Checking for deleted pages`)\n\n  const deletedPages = deleteUntouchedPages(\n    store.getState().pages,\n    timestamp,\n    !!shouldRunCreatePagesStatefully\n  )\n\n  reporter.verbose(\n    `Deleted ${deletedPages.length} page${deletedPages.length === 1 ? `` : `s`}`\n  )\n\n  const tim = reporter.activityTimer(`Checking for changed pages`)\n  tim.start()\n\n  const { changedPages } = findChangedPages(\n    currentPages,\n    store.getState().pages\n  )\n\n  reporter.verbose(\n    `Found ${changedPages.length} changed page${\n      changedPages.length === 1 ? `` : `s`\n    }`\n  )\n  tim.end()\n\n  store.dispatch(actions.apiFinished({ apiName: `createPages` }))\n\n  return {\n    changedPages,\n    deletedPages,\n  }\n}\n"],"file":"create-pages.js"}