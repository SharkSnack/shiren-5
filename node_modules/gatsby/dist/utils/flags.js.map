{"version":3,"sources":["../../src/utils/flags.ts"],"names":["satisfiesSemvers","semverConstraints","result","_","toPairs","every","packageName","semverConstraint","packageVersion","require","version","e","semver","satisfies","includePrerelease","activeFlags","name","env","command","telemetryId","experimental","description","includedFlags","testFitness","umbrellaIssue","noCI"],"mappings":"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","sourcesContent":["import _ from \"lodash\"\nimport semver from \"semver\"\n\nimport sampleSiteForExperiment from \"./sample-site-for-experiment\"\n\n// Does this experiment run for only builds\ntype executingCommand = \"build\" | \"develop\" | \"all\"\n\nexport const satisfiesSemvers = (\n  semverConstraints: Record<string, string>\n): boolean => {\n  // Check each semver check for the flag.\n  // If any are false, then the flag doesn't pass\n  const result = _.toPairs(semverConstraints).every(\n    ([packageName, semverConstraint]) => {\n      let packageVersion: string\n      try {\n        packageVersion = require(`${packageName}/package.json`).version\n      } catch (e) {\n        return false\n      }\n\n      // We care if the semver check doesn't pass.\n      return semver.satisfies(packageVersion, semverConstraint, {\n        includePrerelease: true,\n      })\n    }\n  )\n\n  return result\n}\n\nexport type fitnessEnum = true | false | \"OPT_IN\" | \"LOCKED_IN\"\n\nexport interface IFlag {\n  name: string\n  env: string\n  description: string\n  command: executingCommand\n  /**\n   * Use string identifier to track enabled flag or false to disable any tracking (useful when flag becomes new defaults)\n   */\n  telemetryId: string | false\n  // Heuristics for deciding if a flag is experimental:\n  // - there are known bugs most people will encounter and that block being\n  // able to use Gatsby normally\n  // - very few people have tested the feature so we're not sure if we've\n  // uncovered even common problems.\n  //\n  // Flags should start as experimental but once all serious known bugs are\n  // resolved and ~50+ people have tested it, experimental should be set to\n  // false.\n  experimental: boolean\n  /**\n   * True means conditions for the feature are met and can be opted in by user.\n   *\n   * False means it'll be disabled despite the user setting it true e.g.\n   * it just won't work e.g. it doesn't have new enough version for something.\n   *\n   * OPT_IN means the gatsby will enable the flag (unless the user explicitly\n   * disables it.\n   *\n   * LOCKED_IN means that feature is enabled always (unless `noCI` condition is met).\n   * This is mostly to provide more meaningful terminal messages instead of removing\n   * flag from the flag list when users has the flag set in configuration\n   * (avoids showing unknown flag message and shows \"no longer needed\" message).\n   */\n  testFitness: (flag: IFlag) => fitnessEnum\n  includedFlags?: Array<string>\n  umbrellaIssue?: string\n  noCI?: boolean\n}\n\nconst activeFlags: Array<IFlag> = [\n  {\n    name: `FAST_DEV`,\n    env: `GATSBY_EXPERIMENTAL_FAST_DEV`,\n    command: `develop`,\n    telemetryId: `FastDev`,\n    experimental: false,\n    description: `Enable all experiments aimed at improving develop server start time`,\n    includedFlags: [\n      `DEV_SSR`,\n      `PRESERVE_FILE_DOWNLOAD_CACHE`,\n      `PRESERVE_WEBPACK_CACHE`,\n    ],\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `DEV_SSR`,\n    env: `GATSBY_EXPERIMENTAL_DEV_SSR`,\n    command: `develop`,\n    telemetryId: `DevSsr`,\n    experimental: false,\n    description: `Server Side Render (SSR) pages on full reloads during develop. Helps you detect SSR bugs and fix them without needing to do full builds. See umbrella issue for how to update custom webpack config.`,\n    umbrellaIssue: `https://gatsby.dev/dev-ssr-feedback`,\n    testFitness: (): fitnessEnum => {\n      if (sampleSiteForExperiment(`DEV_SSR`, 20)) {\n        return `OPT_IN`\n      } else {\n        return true\n      }\n    },\n  },\n  {\n    name: `QUERY_ON_DEMAND`,\n    env: `GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND`,\n    command: `develop`,\n    telemetryId: false,\n    experimental: false,\n    description: `Only run queries when needed instead of running all queries upfront. Speeds starting the develop server.`,\n    umbrellaIssue: `https://gatsby.dev/query-on-demand-feedback`,\n    noCI: true,\n    testFitness: (): fitnessEnum => `LOCKED_IN`,\n  },\n  {\n    name: `LAZY_IMAGES`,\n    env: `GATSBY_EXPERIMENTAL_LAZY_IMAGES`,\n    command: `develop`,\n    telemetryId: false,\n    experimental: false,\n    description: `Don't process images during development until they're requested from the browser. Speeds starting the develop server. Requires gatsby-plugin-sharp@2.10.0 or above.`,\n    umbrellaIssue: `https://gatsby.dev/lazy-images-feedback`,\n    noCI: true,\n    testFitness: (): fitnessEnum => {\n      const semverConstraints = {\n        // Because of this, this flag will never show up\n        \"gatsby-plugin-sharp\": `>=2.10.0`,\n      }\n      if (satisfiesSemvers(semverConstraints)) {\n        return `LOCKED_IN`\n      } else {\n        // gatsby-plugin-sharp is either not installed or not new enough so\n        // just disable â€” it won't work anyways.\n        return false\n      }\n    },\n  },\n  {\n    name: `PRESERVE_WEBPACK_CACHE`,\n    env: `GATSBY_EXPERIMENTAL_PRESERVE_WEBPACK_CACHE`,\n    command: `all`,\n    telemetryId: `PreserveWebpackCache`,\n    experimental: false,\n    description: `Use webpack's persistent caching and don't delete webpack's cache when changing gatsby-node.js & gatsby-config.js files.`,\n    umbrellaIssue: `https://gatsby.dev/cache-clearing-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `PRESERVE_FILE_DOWNLOAD_CACHE`,\n    env: `GATSBY_EXPERIMENTAL_PRESERVE_FILE_DOWNLOAD_CACHE`,\n    command: `all`,\n    telemetryId: `PreserveFileDownloadCache`,\n    experimental: false,\n    description: `Don't delete the downloaded files cache when changing gatsby-node.js & gatsby-config.js files.`,\n    umbrellaIssue: `https://gatsby.dev/cache-clearing-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `PARALLEL_SOURCING`,\n    env: `GATSBY_EXPERIMENTAL_PARALLEL_SOURCING`,\n    command: `all`,\n    telemetryId: `ParallelSourcing`,\n    experimental: true,\n    description: `Run all source plugins at the same time instead of serially. For sites with multiple source plugins, this can speedup sourcing and transforming considerably.`,\n    umbrellaIssue: `https://gatsby.dev/parallel-sourcing-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `FUNCTIONS`,\n    env: `GATSBY_EXPERIMENTAL_FUNCTIONS`,\n    command: `all`,\n    telemetryId: `Functions`,\n    experimental: true,\n    description: `Compile Serverless functions in your Gatsby project and write them to disk, ready to deploy to Gatsby Cloud`,\n    umbrellaIssue: `https://gatsby.dev/functions-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n]\n\nexport default activeFlags\n"],"file":"flags.js"}